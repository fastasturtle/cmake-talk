<!doctype html>
<!--suppress HtmlFormInputWithoutLabel -->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>reveal.js</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">

        <section class="title">
            <div>
                <h1>Подводные камни CMake</h1>
                <h3>и где они обитают</h3>
                <p  style="margin-top: 5em;">Дмитрий Кожевников</p>
            </div>
        </section>

        <section data-markdown>
<textarea data-template>
## Что такое CMake

* система генерации проектов
* система сборки
* инструмент для тестирования (CTest)
* инструмент для создания пакетов и инсталляторов (CPack)
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Зачем?

* Windows/Linux/macOS
* clang/gcc/cl.exe
* Make/Ninja/VS solutions/Xcode projects/...
* IDE

</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Пример
#### (на самом деле нет)

```cmake
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(MyProject)

FIND_PACKAGE(Boost REQUIRED)
INCLUDE_DIRECTORIES(${Boost_INCLUDE_DIR})

ADD_EXECUTABLE(myapp myMain.cpp)

TARGET_LINK_LIBRARIES(myapp ${Boost_LIBRARIES})
```
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Проблемы

* Странный синтаксис
* Глобальное состояние
* Много способов решать одни и те же задачи
* Устаревшая информация/дезинформация
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Дезинформация: Google

![](img/add_library.png)

</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Дезинформация: cmake_minimum_required

```cmake
cmake_minimum_required(VERSION 2.8)
```

* Не запрещает использовать фичи из более новых версий
* Включает имитацию особенностей старых версий (CMake policies)
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Двойное раскрытие переменных
```cmake
cmake_minimum_required(VERSION 2.6)
project(xxx)

set(GNU 1)
# later
if ("${CMAKE_CXX_COMPILER_ID}" MATCHES "GNU")
    message("OK")
else()
    message("FAIL")
endif()
```

Выведет "FAIL" (с предупреждением) в новых версиях CMake
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## cmake_minimum_required (на самом деле нет)
```cmake
cmake_minimum_required(VERSION 2.6)

foreach(x RANGE 10)
    # introduced in CMake 3.3
    continue()
endforeach()
```

Работает в новых версиях, не работает в старх версиях
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Переменные (окружения)

* Переменные CMake
    - Пример обычных переменных
    - Пример, как передавать через КС

* Переменные окружения
    - Пример переменных окружения
    - Пример, как передавать через КС
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## CMakeCache.txt

* Файл в build-директории
* Двойной назначение:
    - Редактор настроек
        - `vi CMakeCache.txt`
        - `ccache`
        - CMake GUI
    - Кэш долгих операций при конфигурации
        - Общение с компилятором
        - Поиск библиотек
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Выбор компилятора
</textarea>
        </section>


        <section data-markdown>
<textarea data-template>
## Смена компилятора: gotcha
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Кросс-компиляция

Вручную:
```console
$ cmake \
    -DCMAKE_CXX_COMPILER=/path/to/g++ \
    -DCMAKE_SYSTEM_NAME=Linux \
    -DCMAKE_FIND_ROOT_PATH=... \
    ...
```
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Toolchain file

```cmake
set(CMAKE_CXX_COMPILER "/path/to/g++")
set(CMAKE_SYSTEM_NAME "Linux")
set(CMAKE_FIND_ROOT_PATH "...")
# ...
```

```console
$ cmake -DCMAKE_TOOLCHAIN_FILE=/path/to/toolchain
```

Преимущества:
- Можно написать один раз и использовать в разных проектах
- Может быть написан автором toolchain-а
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Modern cmake?

```cmake
...
```

* Как узнать имена переменных?
* Как понять, какие из них использовать?
* Как понять, какие еще требования к использованию есть у библиотеки?
    - примеры
    - примеры
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## target_link_libraries

> `target_link_libraries()` is the most mis-named command in the history of commands, maybe ever
>
> -- <cite>Donald J. Trump</cite>

</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## target_link_libraries

Варианты использования:
1. Linker flag
2. Library name
3. Target name

</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Modern CMake!

```cmake
...

```

"::" в `boost::filesystem` запрещает нежелательное поведение `target_link_libraries()`
</textarea>
        </section>


        <section data-markdown>
<textarea data-template>
## Imported target
Cоздать target с нужными свойствами

```cmake
...

```

"::" в `boost::filesystem` запрещает нежелательное поведение `target_link_libraries()`
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Exported target
Автоматизация создания imported targets
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Отладка
* RTFM
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Отладка
* RTFM
* Отладочная печать
* Отладочные флаги
* Граф зависимостей
* Сюрприз
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Отладочная печать
* Отладочная печать
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Отладочные флаги
* Отладочная печать
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Интерактивный отладчик
* Интерактивный отладчик
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Интерактивный отладчик
* Интерактивный отладчик
</textarea>
        </section>

        <section data-markdown>
<textarea data-template>
## Интерактивный отладчик
* Интерактивный отладчик
</textarea>
        </section>


        <section data-markdown>
<textarea data-template>
##
* Интерактивный отладчик
</textarea>
        </section>

    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>
    // More info about config & dependencies:
    // - https://github.com/hakimel/reveal.js#configuration
    // - https://github.com/hakimel/reveal.js#dependencies
    Reveal.initialize({
        dependencies: [
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {
                src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                    hljs.initHighlightingOnLoad();
                }
            }
        ]
    });
</script>
</body>
</html>
